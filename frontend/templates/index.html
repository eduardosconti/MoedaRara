<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MoedaRara AR</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background: #f5f5f5;
			}
			#camera-container {
				position: relative;
				width: 100%;
				height: 500px;
				border: 3px solid #2196f3;
				border-radius: 10px;
				overflow: hidden;
			}
			#video {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1);
			}
			#target-overlay {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 250px;
				height: 250px;
				border: 3px dashed #4caf50;
				border-radius: 50%;
				pointer-events: none;
			}
			#capture-btn {
				display: block;
				margin: 20px auto;
				padding: 15px 30px;
				background: #2196f3;
				color: white;
				border: none;
				border-radius: 25px;
				cursor: pointer;
				font-size: 1.1em;
				transition: 0.3s;
			}
			#capture-btn:hover {
				background: #1976d2;
			}
			#result-container {
				display: none;
				margin-top: 30px;
				padding: 20px;
				background: white;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			#model-canvas {
				width: 300px;
				height: 300px;
				border: 2px solid #f44336;
				border-radius: 10px;
				margin: 0 auto;
				display: block;
			}
			.status-badge {
				padding: 8px 15px;
				border-radius: 20px;
				font-weight: bold;
				margin-top: 15px;
			}
			.normal {
				background: #4caf50;
				color: white;
			}
			.anomalo {
				background: #f44336;
				color: white;
			}
		</style>
	</head>
	<body>
		<h1 style="text-align: center; color: #333">MoedaRara - An치lise AR</h1>

		<div id="camera-container">
			<video id="video" autoplay playsinline></video>
			<div id="target-overlay"></div>
		</div>

		<button id="capture-btn">Capturar Moeda</button>

		<div id="result-container">
			<canvas id="model-canvas"></canvas>
			<div style="text-align: center; margin-top: 20px">
				<h3 id="classe-texto" style="color: #333"></h3>
				<div id="status" class="status-badge"></div>
			</div>
		</div>

		<script>
			const video = document.getElementById("video");
			const captureBtn = document.getElementById("capture-btn");
			const modelCanvas = document.getElementById("model-canvas");
			const ctx = modelCanvas.getContext("2d");
			const resultContainer = document.getElementById("result-container");

			// Acessar c칙mera
			navigator.mediaDevices
				.getUserMedia({
					video: {
						facingMode: "environment",
						width: { ideal: 1280 },
						height: { ideal: 720 },
					},
				})
				.then((stream) => {
					video.srcObject = stream;
				})
				.catch((error) => {
					console.error("Erro na c칙mera:", error);
					alert("Erro ao acessar a c칙mera!");
				});

			// Capturar imagem
			captureBtn.addEventListener("click", async () => {
				try {
					captureBtn.disabled = true;
					captureBtn.textContent = "Processando...";

					const canvas = document.createElement("canvas");
					const context = canvas.getContext("2d");

					canvas.width = 300;
					canvas.height = 300;

					context.drawImage(
						video,
						(video.videoWidth - 300) / 2,
						(video.videoHeight - 300) / 2,
						300,
						300,
						0,
						0,
						300,
						300
					);

					const blob = await new Promise((resolve) =>
						canvas.toBlob(resolve, "image/jpeg", 0.9)
					);
					const formData = new FormData();
					formData.append("image", blob);

					const response = await fetch("http://127.0.0.1:5000/classificar", {
						method: "POST",
						body: formData,
					});

					const data = await response.json();
					resultContainer.style.display = "block";

					// Atualizar UI
					document.getElementById(
						"classe-texto"
					).textContent = `Classe: ${data.classe_moeda}`;
					const statusElement = document.getElementById("status");
					statusElement.textContent = data.status;
					statusElement.className = `status-badge ${
						data.status === "Normal" ? "normal" : "anomalo"
					}`;

					// Desenhar modelo com anomalias
					if (data.anomaly_mask && data.original_img) {
						const originalImg = new Image();
						originalImg.onload = () => {
							modelCanvas.width = originalImg.width;
							modelCanvas.height = originalImg.height;
							ctx.drawImage(originalImg, 0, 0);

							const maskImg = new Image();
							maskImg.onload = () => {
								ctx.globalAlpha = 0.5;
								ctx.drawImage(maskImg, 0, 0);
								ctx.globalAlpha = 1.0;
							};
							maskImg.src = `data:image/png;base64,${data.anomaly_mask}`;
						};
						originalImg.src = `data:image/png;base64,${data.original_img}`;
					}
				} catch (error) {
					console.error("Erro:", error);
					alert("Erro ao processar moeda!");
				} finally {
					captureBtn.disabled = false;
					captureBtn.textContent = "Capturar Moeda";
				}
			});
		</script>
	</body>
</html>
